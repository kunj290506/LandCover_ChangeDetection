#!/usr/bin/env python3
\"\"\"\nMemory-Optimized Training Launcher\nRun this script to start training immediately\n\"\"\"\n\nimport os\nimport sys\nimport torch\nimport logging\nfrom pathlib import Path\n\n# Set up paths\nproject_root = Path(__file__).parent\nsys.path.insert(0, str(project_root / \"src\"))\nsys.path.insert(0, str(project_root / \"services\" / \"training\" / \"app\"))\nsys.path.insert(0, str(project_root / \"services\" / \"common\"))\n\n# Import training components\nfrom trainer import run_training\nfrom landcover_common.settings import Settings\n\n\ndef setup_logging():\n    \"\"\"Setup simple console logging\"\"\"\n    logging.basicConfig(\n        level=logging.INFO,\n        format='%(asctime)s - %(levelname)s - %(message)s'\n    )\n\n\ndef check_memory():\n    \"\"\"Check available memory and GPU\"\"\"\n    if torch.cuda.is_available():\n        gpu_memory = torch.cuda.get_device_properties(0).total_memory / 1e9\n        print(f\"ğŸ”¥ GPU Available: {torch.cuda.get_device_name(0)}\")\n        print(f\"ğŸ”¥ GPU Memory: {gpu_memory:.1f} GB\")\n    else:\n        print(\"âš ï¸  No GPU detected - using CPU (will be slower)\")\n    \n    # Clear GPU cache if available\n    if torch.cuda.is_available():\n        torch.cuda.empty_cache()\n        print(\"ğŸ§¹ GPU cache cleared\")\n\n\ndef check_dataset():\n    \"\"\"Check if dataset exists\"\"\"\n    dataset_path = project_root / \"data\" / \"LEVIR-CD-patches\"\n    train_list = project_root / \"train_list.txt\"\n    \n    if not dataset_path.exists():\n        print(f\"âŒ Dataset not found at {dataset_path}\")\n        print(\"Please ensure LEVIR-CD dataset is available\")\n        return False\n    \n    if not train_list.exists():\n        print(f\"âŒ Training list not found at {train_list}\")\n        return False\n    \n    print(f\"âœ… Dataset found at {dataset_path}\")\n    return True\n\n\ndef start_training():\n    \"\"\"Start optimized training\"\"\"\n    print(\"ğŸš€ Starting Memory-Optimized Training...\")\n    \n    # Set memory efficient settings\n    os.environ[\"PYTORCH_CUDA_ALLOC_CONF\"] = \"max_split_size_mb:128\"\n    \n    # Use local paths for training\n    dataset_uri = str(project_root / \"data\" / \"LEVIR-CD-patches\")\n    config_uri = str(project_root / \"config\" / \"train_config.yaml\")\n    \n    try:\n        # Start training\n        run_id = run_training(\n            dataset_uri=dataset_uri,\n            config_uri=config_uri,\n            register_model=True\n        )\n        \n        print(f\"ğŸ‰ Training completed! MLflow Run ID: {run_id}\")\n        print(f\"ğŸ“Š View results at: http://localhost:5000\")\n        \n    except Exception as e:\n        print(f\"âŒ Training failed: {e}\")\n        import traceback\n        traceback.print_exc()\n\n\nif __name__ == \"__main__\":\n    print(\"=\" * 60)\n    print(\"ğŸ¯ LAND COVER CHANGE DETECTION - TRAINING READY\")\n    print(\"=\" * 60)\n    \n    setup_logging()\n    check_memory()\n    \n    if check_dataset():\n        print(\"\\nâœ… All systems ready for training!\")\n        print(\"ğŸ’¡ Type 'go' to start training or Ctrl+C to exit\")\n        \n        # Wait for user input\n        try:\n            user_input = input(\"\\nğŸ‘‰ Command: \").strip().lower()\n            if user_input == \"go\":\n                start_training()\n            else:\n                print(\"Training cancelled.\")\n        except KeyboardInterrupt:\n            print(\"\\nTraining cancelled.\")\n    else:\n        print(\"\\nâŒ Please fix dataset issues before training.\")\n